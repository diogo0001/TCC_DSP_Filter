% Filtro crossover FIR
% Autor : Diogo Tavares
%
%-------------------------------------------------------------------
% Filtro LP/HP
% fc = 500 Hz
% tapps = 300
%
% deve-se carregar o projeto do filtro no fda tool 'designer_cheb_n150_LP.fda'
% exportar em : file/export -> export to: Workspace Numerator -> NumL e
% NumH
% definidos os coeficientes nos vetores 
%-------------------------------------------------------------------
proc = 1;
write_file = 0;
play = 1;
% file = 'audio_files/noise.wav';
file = 'audio_files/sweep_20_1000Hz.wav';
save_file = strcat('fir_cross_',file);

NumH = [1.43202938669806e-07 1.03614675538905e-07 1.43100923060845e-07 1.92039942087177e-07 2.51671670233148e-07 3.23212755070761e-07 4.07810136776771e-07 5.06485703670399e-07 6.20071581393976e-07 7.49135747461429e-07 8.93897819871268e-07 1.05413505176991e-06 1.22907877358832e-06 1.41730175898312e-06 1.61659725002794e-06 1.82385065858523e-06 2.03490526214722e-06 2.24442353055970e-06 2.44574605112327e-06 2.63075035920994e-06 2.78971232462047e-06 2.91117308480764e-06 2.98181484849904e-06 2.98634921048237e-06 2.90742191306313e-06 2.72553825450865e-06 2.41901357172758e-06 1.96395340558098e-06 1.33426808448899e-06 5.01726527552568e-07 -5.63945935580461e-07 -1.89492101155607e-06 -3.52506760461133e-06 -5.48969439389879e-06 -7.82523087719899e-06 -1.05688433790387e-05 -1.37579830711517e-05 -1.74298637067936e-05 -2.16208675283027e-05 -2.63658786677510e-05 -3.16975443212160e-05 -3.76454650327570e-05 -4.42353165686401e-05 -5.14879070869375e-05 -5.94181746023813e-05 -6.80341310986810e-05 -7.73357610371310e-05 -8.73138834347466e-05 -9.79489881207264e-05 -0.000109210058207163 -0.000121053392209391 -0.000133421440600476 -0.000146241672862407 -0.000159425492279259 -0.000172867216783172 -0.000186443145087305 -0.000200010728100526 -0.000213407866191501 -0.000226452353235856 -0.000238941488518071 -0.000250651877452347 -0.000261339441716535 -0.000270739658748915 -0.000278568049625865 -0.000284520933113867 -0.000288276462165697 -0.000289495957310416 -0.000287825549269278 -0.000282898140727427 -0.000274335694511702 -0.000261751852488734 -0.000244754886320051 -0.000222950977824835 -0.000195947823127009 -0.000163358551044056 -0.000124805942340000 -7.99269325633850e-05 -2.83773772608382e-05 3.01629455473614e-05 9.59851245767618e-05 0.000169345728824145 0.000250461281625336 0.000339502634685622 0.000436589284537530 0.000541783676518513 0.000655085543596328 0.000776426329136881 0.000905663743962915 0.00104257650873138 0.00118685933272093 0.00133811817951045 0.00149586586871295 0.00165951806084869 0.00182838966957185 0.00200169174175467 0.00217852884135600 0.00235789696751111 0.00253868203084841 0.00271965890461160 0.00289949105871375 0.00307673077529506 0.00324981993365027 0.00341709134042527 0.00357677056765759 0.00372697824638450 0.00386573274698183 0.00399095315884426 0.00410046246115264 0.00419199075281209 0.00426317838261495 0.00431157878947139 0.00433466082614040 0.00432981029689898 0.00429433038821097 0.00422544060928514 0.00412027378326590 0.00397587053538021 0.00378917060594136 0.00355700016586097 0.00327605411963151 0.00294287213095062 0.00255380677898231 0.00210498182019859 0.00159223795154711 0.00101106268761670 0.000356499893933294 -0.000376966962292098 -0.00119556585649367 -0.00210643250193828 -0.00311786708874796 -0.00423967285500033 -0.00548360709036440 -0.00686398912642163 -0.00839853143704823 -0.0101094940707932 -0.0120253179063649 -0.0141829843445487 -0.0166315075078258 -0.0194372474962425 -0.0226922578584503 -0.0265279020573855 -0.0311380770584979 -0.0368210095484484 -0.0440596248287216 -0.0536895794963864 -0.0672913222470398 -0.0882542372395456 -0.125394698972474 -0.211046289237392 -0.636232437513811 0.636232437513811 0.211046289237392 0.125394698972474 0.0882542372395456 0.0672913222470398 0.0536895794963864 0.0440596248287216 0.0368210095484484 0.0311380770584979 0.0265279020573855 0.0226922578584503 0.0194372474962425 0.0166315075078258 0.0141829843445487 0.0120253179063649 0.0101094940707932 0.00839853143704823 0.00686398912642163 0.00548360709036440 0.00423967285500033 0.00311786708874796 0.00210643250193828 0.00119556585649367 0.000376966962292098 -0.000356499893933294 -0.00101106268761670 -0.00159223795154711 -0.00210498182019859 -0.00255380677898231 -0.00294287213095062 -0.00327605411963151 -0.00355700016586097 -0.00378917060594136 -0.00397587053538021 -0.00412027378326590 -0.00422544060928514 -0.00429433038821097 -0.00432981029689898 -0.00433466082614040 -0.00431157878947139 -0.00426317838261495 -0.00419199075281209 -0.00410046246115264 -0.00399095315884426 -0.00386573274698183 -0.00372697824638450 -0.00357677056765759 -0.00341709134042527 -0.00324981993365027 -0.00307673077529506 -0.00289949105871375 -0.00271965890461160 -0.00253868203084841 -0.00235789696751111 -0.00217852884135600 -0.00200169174175467 -0.00182838966957185 -0.00165951806084869 -0.00149586586871295 -0.00133811817951045 -0.00118685933272093 -0.00104257650873138 -0.000905663743962915 -0.000776426329136881 -0.000655085543596328 -0.000541783676518513 -0.000436589284537530 -0.000339502634685622 -0.000250461281625336 -0.000169345728824145 -9.59851245767618e-05 -3.01629455473614e-05 2.83773772608382e-05 7.99269325633850e-05 0.000124805942340000 0.000163358551044056 0.000195947823127009 0.000222950977824835 0.000244754886320051 0.000261751852488734 0.000274335694511702 0.000282898140727427 0.000287825549269278 0.000289495957310416 0.000288276462165697 0.000284520933113867 0.000278568049625865 0.000270739658748915 0.000261339441716535 0.000250651877452347 0.000238941488518071 0.000226452353235856 0.000213407866191501 0.000200010728100526 0.000186443145087305 0.000172867216783172 0.000159425492279259 0.000146241672862407 0.000133421440600476 0.000121053392209391 0.000109210058207163 9.79489881207264e-05 8.73138834347466e-05 7.73357610371310e-05 6.80341310986810e-05 5.94181746023813e-05 5.14879070869375e-05 4.42353165686401e-05 3.76454650327570e-05 3.16975443212160e-05 2.63658786677510e-05 2.16208675283027e-05 1.74298637067936e-05 1.37579830711517e-05 1.05688433790387e-05 7.82523087719899e-06 5.48969439389879e-06 3.52506760461133e-06 1.89492101155607e-06 5.63945935580461e-07 -5.01726527552568e-07 -1.33426808448899e-06 -1.96395340558098e-06 -2.41901357172758e-06 -2.72553825450865e-06 -2.90742191306313e-06 -2.98634921048237e-06 -2.98181484849904e-06 -2.91117308480764e-06 -2.78971232462047e-06 -2.63075035920994e-06 -2.44574605112327e-06 -2.24442353055970e-06 -2.03490526214722e-06 -1.82385065858523e-06 -1.61659725002794e-06 -1.41730175898312e-06 -1.22907877358832e-06 -1.05413505176991e-06 -8.93897819871268e-07 -7.49135747461429e-07 -6.20071581393976e-07 -5.06485703670399e-07 -4.07810136776771e-07 -3.23212755070761e-07 -2.51671670233148e-07 -1.92039942087177e-07 -1.43100923060845e-07 -1.03614675538905e-07 -1.43202938669806e-07];
NumL = [-5.41369829208177e-08 -3.15706684801648e-08 -3.35145450791273e-08 -3.18466424778653e-08 -2.48975098004373e-08 -1.06278509815070e-08 1.34095740171613e-08 5.01058889911316e-08 1.02828597783971e-07 1.75449209143156e-07 2.72364426945511e-07 3.98509219321866e-07 5.59359972919933e-07 7.60925851403080e-07 1.00972641455571e-06 1.31275352034779e-06 1.67741553124914e-06 2.11146188209454e-06 2.62288614378043e-06 3.21980583860767e-06 3.91031743234813e-06 4.70232514777771e-06 5.60334251655354e-06 6.62026591229190e-06 7.75911968811256e-06 9.02477297646902e-06 1.04206286965504e-05 1.19482858526708e-05 1.36071767925381e-05 1.53941817226891e-05 1.73032234441208e-05 1.93248459675326e-05 2.14457813867663e-05 2.36485101220387e-05 2.59108203813918e-05 2.82053734184358e-05 3.04992818750476e-05 3.27537091765352e-05 3.49234985805827e-05 3.69568410562555e-05 3.87949916713632e-05 4.03720445813437e-05 4.16147770264086e-05 4.24425729421955e-05 4.27674368593448e-05 4.24941086968276e-05 4.15202898310819e-05 3.97369904379733e-05 3.70290075487188e-05 3.32755425274026e-05 2.83509657618204e-05 2.21257352585361e-05 1.44674745470988e-05 5.24221382979299e-06 -5.68420333274695e-06 -1.84445473252316e-05 -3.31684652699173e-05 -4.99805829252029e-05 -6.89984515550394e-05 -9.03303479882075e-05 -0.000114072938526751 -0.000140308819863480 -0.000169103952701781 -0.000200505006307076 -0.000234536634726217 -0.000271198707855356 -0.000310463522883424 -0.000352273023851686 -0.000396536059113448 -0.000443125708315885 -0.000491876712122155 -0.000542583039211905 -0.000594995626108519 -0.000648820326050998 -0.000703716103428284 -0.000759293510198796 -0.000815113480205733 -0.000870686476351337 -0.000925472024197345 -0.000978878663705483 -0.00103026434851772 -0.00107893731940310 -0.00112415747527408 -0.00116513826151402 -0.00120104909127901 -0.00123101831096603 -0.00125413671620919 -0.00126946161961174 -0.00127602146598847 -0.00127282098522883 -0.00125884686704812 -0.00123307393593196 -0.00119447179855713 -0.00114201192995686 -0.00107467515875659 -0.000991459506007476 -0.000891388326558906 -0.000773518696609473 -0.000636949986127632 -0.000480832550307222 -0.000304376470185336 -0.000106860269063347 0.000112360471505184 0.000353844674609855 0.000618057589714935 0.000905362953930735 0.00121601557349308 0.00155015440527182 0.00190779621645223 0.00228882989801826 0.00269301150431373 0.00311996008677798 0.00356915438496480 0.00403993043218833 0.00453148012663501 0.00504285081158618 0.00557294590056732 0.00612052657484495 0.00668421457180314 0.00726249607343025 0.00785372669452048 0.00845613756033662 0.00906784245348834 0.00968684599975498 0.0103110528526270 0.0109382778265611 0.0115662569194441 0.0121926591556462 0.0128150991724119 0.0134311504642908 0.0140383591929359 0.0146342584629881 0.0152163829589945 0.0157822838334551 0.0163295437322109 0.0168557918405373 0.0173587188315262 0.0178360915976628 0.0182857676469464 0.0187057090464785 0.0190939957991346 0.0194488385427425 0.0197685904660671 0.0200517583418220 0.0202970125838245 0.0205031962432345 0.0206693328674834 0.0207946331549264 0.0208785003483546 0.0209205343211712 0.0209205343211712 0.0208785003483546 0.0207946331549264 0.0206693328674834 0.0205031962432345 0.0202970125838245 0.0200517583418220 0.0197685904660671 0.0194488385427425 0.0190939957991346 0.0187057090464785 0.0182857676469464 0.0178360915976628 0.0173587188315262 0.0168557918405373 0.0163295437322109 0.0157822838334551 0.0152163829589945 0.0146342584629881 0.0140383591929359 0.0134311504642908 0.0128150991724119 0.0121926591556462 0.0115662569194441 0.0109382778265611 0.0103110528526270 0.00968684599975498 0.00906784245348834 0.00845613756033662 0.00785372669452048 0.00726249607343025 0.00668421457180314 0.00612052657484495 0.00557294590056732 0.00504285081158618 0.00453148012663501 0.00403993043218833 0.00356915438496480 0.00311996008677798 0.00269301150431373 0.00228882989801826 0.00190779621645223 0.00155015440527182 0.00121601557349308 0.000905362953930735 0.000618057589714935 0.000353844674609855 0.000112360471505184 -0.000106860269063347 -0.000304376470185336 -0.000480832550307222 -0.000636949986127632 -0.000773518696609473 -0.000891388326558906 -0.000991459506007476 -0.00107467515875659 -0.00114201192995686 -0.00119447179855713 -0.00123307393593196 -0.00125884686704812 -0.00127282098522883 -0.00127602146598847 -0.00126946161961174 -0.00125413671620919 -0.00123101831096603 -0.00120104909127901 -0.00116513826151402 -0.00112415747527408 -0.00107893731940310 -0.00103026434851772 -0.000978878663705483 -0.000925472024197345 -0.000870686476351337 -0.000815113480205733 -0.000759293510198796 -0.000703716103428284 -0.000648820326050998 -0.000594995626108519 -0.000542583039211905 -0.000491876712122155 -0.000443125708315885 -0.000396536059113448 -0.000352273023851686 -0.000310463522883424 -0.000271198707855356 -0.000234536634726217 -0.000200505006307076 -0.000169103952701781 -0.000140308819863480 -0.000114072938526751 -9.03303479882075e-05 -6.89984515550394e-05 -4.99805829252029e-05 -3.31684652699173e-05 -1.84445473252316e-05 -5.68420333274695e-06 5.24221382979299e-06 1.44674745470988e-05 2.21257352585361e-05 2.83509657618204e-05 3.32755425274026e-05 3.70290075487188e-05 3.97369904379733e-05 4.15202898310819e-05 4.24941086968276e-05 4.27674368593448e-05 4.24425729421955e-05 4.16147770264086e-05 4.03720445813437e-05 3.87949916713632e-05 3.69568410562555e-05 3.49234985805827e-05 3.27537091765352e-05 3.04992818750476e-05 2.82053734184358e-05 2.59108203813918e-05 2.36485101220387e-05 2.14457813867663e-05 1.93248459675326e-05 1.73032234441208e-05 1.53941817226891e-05 1.36071767925381e-05 1.19482858526708e-05 1.04206286965504e-05 9.02477297646902e-06 7.75911968811256e-06 6.62026591229190e-06 5.60334251655354e-06 4.70232514777771e-06 3.91031743234813e-06 3.21980583860767e-06 2.62288614378043e-06 2.11146188209454e-06 1.67741553124914e-06 1.31275352034779e-06 1.00972641455571e-06 7.60925851403080e-07 5.59359972919933e-07 3.98509219321866e-07 2.72364426945511e-07 1.75449209143156e-07 1.02828597783971e-07 5.01058889911316e-08 1.34095740171613e-08 -1.06278509815070e-08 -2.48975098004373e-08 -3.18466424778653e-08 -3.35145450791273e-08 -3.15706684801648e-08 -5.41369829208177e-08];

if proc == 1
    
    Q15 = 0;  % para pto fixo = 1, senao =0
    % ao exportar com inteiro, o fdatool faz esta operação
    % pois resulta neste resultado
    if Q15==1
        NumLP = round(NumL*2^15);  
        NumHP = round(NumH*2^15);
    else
        NumLP = NumL;
        NumHP = NumH;
    end

    % aplicando filtro ao ruido ------------

    a = 1;
    amp = 0.1;

    clear audio;
    clear audio_f_LP;
    clear audio_f_HP;
    clear stereo_mtx;

    [audio,fs] = audioread(file);
    audio = audio(:,1);

    % tempo em segundos       
    t = 0:length(audio)-1;
    t = t/fs;

    %aplica o filtro LP e HP em 500 Hz
    audio_f_LP = filter(NumLP,a,audio);
    audio_f_HP = filter(NumHP,a,audio);
    cross_sum = audio_f_LP + audio_f_HP;

    if Q15==1
        audio_f_LP = audio_f_LP/2^15;
        audio_f_HP = audio_f_HP/2^15;
    end
    
    stereo_mtx = [audio_f_HP(:), audio_f_LP(:)];
    
    if write_file == 1
        
        audiowrite(save_file, stereo_mtx, fs);
    end
    
    if play == 1
        sound(stereo_mtx,fs);
    end
end

%% plot --------------------------------------------------
plot = 0;

if plot ==1
    i = 1;
    figure(i);
    plot_fft(audio,fs,'log');
    hold on
    plot_fft(audio_f_LP,fs,'log');
    plot_fft(audio_f_HP,fs,'log');
    hold off;
   
    i=i+1;
    figure(i);
    subplot(2,1,1);
    plot_fft(cross_sum,fs,'log');
    subplot(2,1,2);
    plot_fft(audio,fs,'log');

%     i=i+1;
%     figure(i);
%     plot(t',audio);
%     title('audio')
%     xlabel('Tempo (s)')
%     ylabel('Amplitude')
%     grid on;

    
%     i=i+1;
%     figure(i);
%     plot(t,audio_f_HP);
%     grid on;

%     i=i+1;
%     figure(i);
%     plot(t,audio_f_LP);
%     title('audio Filtrado')
%     xlabel('Tempo (s)')
%     ylabel('Amplitude')
%     grid on;
end

%% Função para mostrar FFT
% Função criada para uso generico de plotagem de graficos FFT

function [fft_max,sig_max] =  plot_fft(sig,fs,xgrid)

	m = length(sig); 
	n = pow2(nextpow2(m));
	y = fft(sig,n); 

	f = (0:n-1)*(fs/n); 
	power = abs(y).^2/n;  

	mxy = max(y);
	fft_max = abs(real(mxy));
	sig_max = max(sig);
	mx = fft_max;

	switch (xgrid)

		case 'db'
            loglog(logsp,power(1:floor(n/2)))
% 			axis([1 20000 10e-5 mx]); 
			grid on
			title('Resposta em frequencia')
			xlabel('Frequencia (Hz)')
			ylabel('Amplitude (db)')

		case 'log'
			semilogx(f(1:floor(n/2)),power(1:floor(n/2)))
			%axis([1 20000 0 mx]); 
			grid on
			title('Resposta em frequencia')
			xlabel('Frequencia (Hz)')
			ylabel('Amplitude')
		case 'lin'
			plot(f(1:floor(n/2)),power(1:floor(n/2)))
			%axis([1 20000 0 mx]); 
			grid on
			title('Resposta em frequencia')
			xlabel('Frequencia (Hz)')
			ylabel('Amplitude')
		end

end